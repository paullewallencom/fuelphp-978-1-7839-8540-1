/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
(function(a){a.templateBootstrap=function(d){d=a.extend({dom_id:"",texts:{newPanel:"New Panel",ok:"OK"}},d);a(function(){var f=false;var j=parent.$(d.dom_id);var i=parent.$;var h=j.find(".template-e-block");a(".customisable").each(function(){var k="";var l=this.id;if(l.search("side")!=-1){k='style="position: relative; top: -30px; float: right; z-index: 40; '}else{if(l=="header"){k='style="position: relative; top: 10px; z-index: 40; display: inline-block; vertical-align: top;'}else{if(l=="principal"){if(a("#header").parent().hasClass("header-fixed")){k='style="position: fixed; top: 10px; left: 50%; z-index: 50;'}else{k='style="position: absolute; top: 10px; left: 50%; z-index: 40;'}}else{k='style="position: relative; top: 0px; float: left; z-index: 40;'}}}k+='"';a(this).prepend('<button type="button" data-block = "'+l+'" class = "btn_custom" '+k+'><i class="glyphicon glyphicon-cog"></i></button>')});a(document).on("mouseenter",".customisable#header >",function(k){var l=a(".customisable , .main_wysiwyg");l.clearQueue();a(".btn_custom").clearQueue();l.not("#principal").not(".side_bar").not(a(this).parent()).animate({opacity:"0.2"},300)});a(document).on("mouseleave",".customisable#header >",function(k){var l=a(".customisable , .main_wysiwyg");l.clearQueue();a(".btn_custom").clearQueue();if(f==false){if(this.id!="principal"){l.animate({opacity:"1"},300)}}});a(document).on("mouseenter",".customisable",function(k){a(".customisable , .main_wysiwyg").clearQueue();a(".btn_custom").clearQueue();if(this.id!="header"&&this.id!="principal"){var l=a(".customisable , .main_wysiwyg").not("#principal").not(".side_bar").not(a(this));if(a(this).hasClass("side_bar")){l.not(a(this).find(".customisable")).animate({opacity:"0.2"},300)}else{if(a(this).parent().hasClass("side_bar")){l.not(a(this).parent()).animate({opacity:"0.2"},300)}else{l.animate({opacity:"0.2"},300)}}}});a(document).on("mouseleave",".customisable",function(k){var l=a(".customisable , .main_wysiwyg");var m=this.id;l.clearQueue();a(".btn_custom").clearQueue();if(f==false){if(m!="header"&&m!="principal"){if(m!="principal"){l.animate({opacity:"1"},300)}}}});a(document).on("click","a",function(){return false});var e=function(){var k=a(this);var m=k.data("enhancer");var l=a.extend(true,{enhancer:m},k.data("config"));a.ajax({url:"admin/noviusos_template_bootstrap/ajax/enhancer",type:"POST",dataType:"json",data:l,success:function(n){k.html(a.trim(n.preview))},error:function(){k.html("Error")}})};a(document).on("click",".btn_custom",function(p){var k=a(this);var m=k.data("block");var q=j.find(".template-e-"+m);var n=q.parent();var o="";var r=q.data("title-popup");var l=q.data("width");var s=q.data("height");if(m.search("blocks-twitter")!=-1){o=a("#"+m).attr("data-twitter-account")}if(!isNaN(s)){s=parseInt(s)}f=true;p.preventDefault();q.nosDialog({title:r,content:q.show(),width:l,minHeight:s,buttons:[{text:d.texts.ok,click:function(){q.nosDialog("close")}}],open:function(){q.nosOnShow()},close:function(){var v=q.find("textarea").not(q.find('[name="css_style"]')).each(function(){var A=i(this);var x=A.tinymce();var y=A.attr("name");var w=a(A.data("target"));var z;if(x){x.save();x.remove()}w.html(A.val()).find(".nosEnhancer, .nosEnhancerInline").each(e)});q.hide().appendTo(n);v.each(function(){var w=i(this);w.wysiwyg(w.data("wysiwyg-options"))});f=false;a(".customisable").animate({opacity:"1"},300);a(".btn_custom").animate({opacity:"1"},300);var u=q.find(':text[name*="account_name"]').val();if(q.attr("class").search("blocks-twitter")!=-1&&o!=u){a("#"+m+" iframe").replaceWith(' <a class="twitter-timeline"  href="https://twitter.com" data-widget-id="448388405479501824"data-screen-name="'+u+'"height="500" data-tweet-limit="">Bad account name</a>');a("#"+m).attr("data-twitter-account",u);twitter(document,"script","twitter-wjs")}if(q.hasClass("template-e-principal")){a("head style").html(q.find('[name="css_style"]').val())}if(q.hasClass("template-e-block-grid")){var t=q.find('[name="wysiwyg_layout"]').attr("value");a.ajax({url:"admin/noviusos_template_bootstrap/ajax/grid",type:"POST",dataType:"html",data:"grid="+t,error:function(){log("Error in template creation")},success:function(w){a("#grid_content_layout").html(w)}})}}})});a(document).find(".nosEnhancer, .nosEnhancerInline").each(e);var g=j.find('[class*="template-e-side-"]').nosOnShow("one",function(){var l=i(this);var n=(l.hasClass("template-e-side-left")?"left":"right");var k=function(z,y){var u="";var r="";var t="";var v=z.find("select");var A=0;var x="";z.find(':checkbox[name^="'+y+'"]').each(function(){if(i(this).parent("li").hasClass("active")){u+=i(this).attr("name")+"||"}});u=u.substring(0,u.length-2);z.find('input[name="_input_hidden_'+y+'"]').val(u);if(z.find('input[name="_input_hidden_'+y+'"]').val()!=""){var s=z.find('input[name="_input_hidden_'+y+'"]').val().split("||");v.find("option").show();for(var w=0;w<(s.length);w++){t=z.find(':checkbox[name="'+s[w]+'"]');r=t.data("target");a(r).appendTo(a("#side-"+y));if(r.search("blocks-twitter")!=-1){a(r+" iframe").replaceWith(' <a class="twitter-timeline"  href="https://twitter.com" data-widget-id="448388405479501824"data-screen-name="'+a(r).attr("data-twitter-account")+'"height="500" data-tweet-limit="">Bad account name</a>');twitter(document,"script","twitter-wjs")}if(t.is(":checked")){a(r).show()}if(r.search("panel")!=-1){A++;if(A==5){v.find('[value = "panel"]').hide()}x=a(r).find(".panel-heading .panel-title").html();t.next().html(x);$input=h.find(t.data("admin-target"));if($input.val()==d.texts.newPanel){h.find($input.data("admin-target")).text(d.texts.newPanel)}}else{v.find('[value = "'+t.attr("name")+'"]').hide()}}}};l.find(".template-e-ul_sort").sortable({stop:function(s,r){k(l,n)}});l.find(".template-e-ul_sort").disableSelection();var q=l.find("input[name='_input_hidden_"+n+"']").val().split("||");l.find(":checkbox").each(function(){var r=i(this);r.closest("li").hide();c(r,a(r.data("target")))});for(var m=0;m<q.length;m++){if(q[m]!=""){var p=l.find("input[name='"+q[m]+"']").closest("li");var o=l.find("input[name='"+q[m]+"']");p.addClass("active").show().insertAfter(p.nextAll("li.active:last"))}}k(l,n);l.find(".btn_suppr_panel").on("click",function(){var s=i(this);var r=l.find("input[name='"+s.data("input")+"']");if(r.prop("checked")==true){r.trigger("click")}r.closest("li").hide().removeClass("active");k(l,n)});l.find("select[name^='_select_']").on("change",function(){var v=i(this);var x=v.attr("name").split("_")[2];var r=l.find("[name='"+v.attr("name")+"'] :selected");var z=r.attr("value");var t=z;if(z=="panel"){for(var w=1;w<6;w++){if(!l.find("[name='"+x+"-blocks-panel_"+w+"-display']").parent("li").hasClass("active")){z=x+"-blocks-panel_"+w+"-display";break}}}var s=l.find("[name='"+z+"']");if(t=="panel"){var y=h.find(s.data("admin-target"));y.val(d.texts.newPanel);var u=a(s.data("target"));u.find(".panel-title").html(d.texts.newPanel)}s.closest("li").show().addClass("active").appendTo(s.closest("ul"));l.find("select[name^='_select'] option[value='']").prop("selected",true);var A=a(s.data("target"));A.appendTo(A.parent());if(s.prop("checked")==false){s.trigger("click")}k(l,x)});l.find(".btn_config_panel").on("click",function(s){var r=i(this);a(r.data("block")).find(".btn_custom").click()});l.find(".btn_write_panel").on("click",function(u){var t=i(this);var r=l.find("#label_"+t.data("input"));var s=l.find("#"+r.attr("for"));var v=a("<input type='text'>");r.parent().parent().enableSelection();r.replaceWith(a("<input/>").attr("type","text").val(r.text()).attr("value",r.text()).attr("name","ipt_temp").blur(function(){a(this).replaceWith(r.html(a(this).val()));a(s.data("target")+" .panel-title").html(a(this).val());h.find(s.data("admin-target")).val(a(this).val());r.parent().parent().disableSelection()}));l.find(":text").focus()})});j.find(".template-e-header").nosOnShow("one",function(){var k=i(this);var l=k.find('select[name="header-type"]');var m=function(n){if(l.val()=="title"){n.find('input[name="medias->logo->medil_media_id"]').closest("tr").hide();n.find('input[name="header-title"]').closest("tr").show();n.find('input[name="header-baseline"]').closest("tr").show()}else{if(l.val()=="image"){n.find('input[name="header-title"]').closest("tr").hide();n.find('input[name="header-baseline"]').closest("tr").hide();n.find('input[name="medias->logo->medil_media_id"]').closest("tr").show()}else{n.find('input[name="medias->logo->medil_media_id"]').closest("tr").show();n.find('input[name="header-title"]').closest("tr").show();n.find('input[name="header-baseline"]').closest("tr").show()}}};m(k);l.change(function(){m(k);if(l.val()=="title"){a("#header-title").show("slow").parent().attr("class","titleonly");a("#header-baseline").show("slow");a("#header-logo , #header-logo-small").hide("slow")}else{if(l.val()=="image"){a("#header-title").hide("slow");a("#header-baseline").hide("slow");a("#header-logo").show("slow")}else{a("#header-title").show("slow").parent().attr("class","title");a("#header-baseline").show("slow");a("#header-logo").show("slow")}}});k.find(":checkbox[name='header-fixed']").click(function(){var o=a("#header").parent();var p=a("#middle_content").parent();var n=a("#footer");var q=a("#principal > button");if(a(this).prop("checked")==true){o.addClass("header-fixed");p.addClass("middle-header-fixed");n.addClass("middle-header-fixed");q.css("position","fixed").css("z-index","50")}else{o.removeClass("header-fixed");p.attr("class","row");n.removeClass("middle-header-fixed");q.css("position","absolute").css("z-index","40")}})});j.find(".template-e-principal").nosOnShow("one",function(){var k=i(this);k.find("[name='_sidebar-display']").change(function(){var n=i(this);var m=function(y,A){var x=y.split(" ");var r=A.split(" ");var s="";var w="";var z=false;for(var u=0;u<x.length;u++){z=false;for(var t=0;t<r.length;t++){if(x[u]==r[t]){z=true;break}}if(z==false){s+=x[u]+" "}}for(var u=0;u<r.length;u++){z=false;for(var t=0;t<x.length;t++){if(r[u]==x[t]){z=true;break}}if(z==false){w+=r[u]+" "}}var v=new Array(2);v[0]=s;v[1]=w;return v};var q=a("#middle_content");var p;var o=a("#side-left");var l=a("#side-right");switch(n.val()){case"left":o.show("slow");l.hide("slow");p=m(q.attr("class")," col-md-8 col-sm-9 col-xs-12");q.switchClass(p[0],p[1]);break;case"right":l.show("slow");o.hide("slow");p=m(q.attr("class"),"col-md-offset-1 col-sm-offset-1 col-md-8 col-sm-9 col-xs-12");q.switchClass(p[0],p[1]);break;case"none":l.hide("slow");o.hide("slow");p=m(q.attr("class"),"col-md-12 col-sm-12 col-xs-12");q.switchClass(p[0],p[1]);break;case"both":l.show("slow");o.show("slow");p=m(q.attr("class"),"col-md-6 col-sm-9 col-xs-12");q.switchClass(p[0],p[1]);break}});k.find("[name='principal-skin']").change(function(){setStyleSheet(k.find("#"+this.id+" :selected").attr("value"))});$jumbotron=k.find(":checkbox[name='jumbotron-display']");c($jumbotron,a("#jumbotron"));$fixed_background=k.find(":checkbox[name='principal-background_fixed_display']");$fixed_background.click(function(){var l=a("body");if(a(this).prop("checked")){l.css("background-attachment","fixed")}else{l.css("background-attachment","inerit")}})});j.find(".template-e-block").nosOnShow("one",function(){var k=i(this);k.find("select[name^='_select'] option[value='']").prop("selected",true);k.find(":text").not(".template-e-select-media, [name*='twitter-account_name'], .template-e-select-menu").on("keydown change focusout",function(){var s=i(this);var n=s.data("target");var r=s.data("admin-target");var q=a(n);var p=h.find(r);if(n=="body"){var m=s.val().split(";");var l="";a("body").css({backgroundRepeat:"initial",backgroundPosition:"initial"}).css("background-size","initial");if(k.find(":checkbox[name='principal-background_fixed_display']").prop("checked")){a("body").css("background-attachement","fixed")}for(var o=0;o<m.length;o++){l=m[o].split(":");a("body").css(a.trim(l[0]),a.trim(l[1]))}}else{if(n.search(" link")!=-1){q=a(n.split(" link")[0]);if(s.val()==""){q.attr("href","")}else{q.attr("href",s.val())}a(".social > li > a ").each(function(){var t=a(this);if(t.attr("href")!=""){t.parent().show()}else{t.parent().hide()}})}else{q.html(s.val());p.html(s.val())}}});k.find(".template-e-select-menu").change(function(){var n=i(this);var m=n.attr("name").split("->")[1];if(n.val()||m=="principal"){a.ajax({type:"GET",dataType:"html",url:"admin/noviusos_template_bootstrap/ajax/menu",data:{menu_id:n.val(),menu_type:m,framework:"bootstrap",context:j.closest(".nos-dispatcher, body").data("nosContext")},success:function(p){var o="";switch(m){case"principal":o="list-menu";break;case"left":o="list-left-menu";break;case"right":o="list-right-menu";break;case"footer":o="list-footer-menu";break}if(p!=""){a("#"+o).replaceWith(p)}else{a("#"+o).html("")}}})}else{var l="";switch(m){case"left":l="list-left-menu";break;case"right":l="list-right-menu";break;case"footer":l="list-footer-menu";break}a("#"+l).hide()}});k.find(".ui-inputfilethumb-fileaction").click(function(){k.find(":text[name*='medias->']").val("").trigger("change")});k.find(".template-e-select-media").change(function(){var n=i(this);var m=a(n.data("target"));var l=function(o){if(m.get(0).nodeName=="BODY"){if(!o){m.removeClass("background");m.attr("style","")}else{m.addClass("background");m.attr("style","background : url('"+o.url+"') no-repeat center center fixed")}}else{if(m.find("img").length){if(!o){m.find("img").attr("src","")}else{m.find("img").attr({src:o.url,width:o.width,height:o.height})}}}};if(n.val()){a.ajax({method:"GET",url:"admin/noviusos_template_bootstrap/ajax/media/"+n.val(),dataType:"json",success:function(o){l(o)}})}else{l()}})})});function c(f,e){b(f,e);f.click(function(){b(f,e)})}function b(f,e){if(f.is(":checked")){e.show("slow")}else{e.hide("slow")}}}})(jQuery);