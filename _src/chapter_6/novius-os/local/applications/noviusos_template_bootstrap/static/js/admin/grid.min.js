/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define(["jquery-nos"],function(a){return function(G){G=a.extend({form_id:"",tpvar_id:""},G);var d;var C;var m;var B=1;var r;var u;var c;var o;var v;var y;var D;var n;var w;var E;var e;var q;var g;var t;var s;d=12;C=12;m=new Array(d);B=1;r=new Array(1);var h=a('[name="wysiwyg_layout"]');var p=a(".template-e-block-grid");var x=a("#div_grid");function l(){var J="";for(var I=0;I<d;I++){for(var H=0;H<C;H++){J+=m[I][H]+" "}J=J.substr(0,J.length-1);J+="|"}J=J.substr(0,J.length-1);h.attr("value",J)}for(var A=0;A<d;A++){m[A]=new Array(C)}for(var A=0;A<d;A++){for(var z=0;z<C;z++){m[A][z]=0}}for(var A=0;A<d;A++){x.prepend("<div id='div_l"+A+"' class='row'></div>");for(var z=0;z<C;z++){a("#div_l"+A).append("<div id='div_l"+A+"_c"+z+"' class='cell'></div>")}}var k=h.val();F(k);a(".grid_pattern").click(function(){F(a(this).find('input[type="hidden"]').val())});a(document).keypress(function(i){if(i.keyCode==46){a("button[id='btn_suppr']").trigger("click")}});a("button[id='btn_vider']").click(function(){for(var i=0;i<d;i++){for(var j=0;j<C;j++){m[i][j]=0}}a(".cell_new").remove()});a("button[id='btn_suppr']").click(function(){var i=a(".selected");u=i.css("top");c=i.css("left");o=(parseInt(u)-4)/48;v=(parseInt(c)-4)/48;q=((parseInt(i.css("height"))-40)/48)+1;g=((parseInt(i.css("width"))-40)/48)+1;for(var j=o;j<q+o;j++){for(var H=v;H<g+v;H++){m[j][H]=0}}a(".selected").remove()});p.on("dragstart",".cell_new",function(j,i){u=a(this).css("top");c=a(this).css("left");a(this).trigger("click")});p.on("dragstop",".cell_new",function(H,I){var L=false;var J=a(this);y=(parseInt(J.css("top"))-4)/48;D=(parseInt(J.css("left"))-4)/48;o=(parseInt(u)-4)/48;v=(parseInt(c)-4)/48;t=((parseInt(J.css("height"))-40)/48)+1;s=((parseInt(J.css("width"))-40)/48)+1;L:for(var i=y;i<t+y;i++){for(var j=D;j<s+D;j++){if(m[i][j]!=0&&m[i][j]!=J.attr("data-new")){L=true;break L}}}if(L){J.draggable("disable");var K=J;J.animate({top:u,left:c},200,function(){a(this).draggable("enable")})}else{if(z!=v||A!=o){for(var i=o;i<t+o;i++){for(var j=v;j<s+v;j++){m[i][j]=0}}}for(var i=y;i<t+y;i++){for(var j=D;j<s+D;j++){m[i][j]=J.attr("data-new")}}}});p.on("resizestart",".cell_new",function(H,i){var j=a(this);n=j.css("height");w=j.css("width");j.trigger("click")});p.on("resizestop",".cell_new",function(J,H){var K=false;var I=a(this);y=(parseInt(I.css("top"))-4)/48;D=(parseInt(I.css("left"))-4)/48;E=I.css("height");e=I.css("width");q=((parseInt(n)-40)/48)+1;g=((parseInt(w)-40)/48)+1;t=((parseInt(E)-40)/48)+1;s=((parseInt(e)-40)/48)+1;K:for(var i=y;i<y+t;i++){for(var j=D;j<D+s;j++){if(m[i][j]!=0&&m[i][j]!=I.attr("data-new")){K=true;break K}}}if(K){I.animate({width:w,height:n},200)}else{for(var i=y;i<y+q;i++){for(var j=D;j<D+g;j++){m[i][j]=0}}for(var i=y;i<y+t;i++){for(var j=D;j<D+s;j++){m[i][j]=I.attr("data-new")}}}});p.on("click","#btn_ajout",function(J){buckle:for(var I=0;I<d;I++){for(var H=0;H<C;H++){if(m[I][H]==0){m[I][H]=""+B;u=(4+(I)*48);c=(4+(H)*48);a(".selected").removeClass("selected");x.append('<div class="cell_new selected" data-new ="'+B+'" style="top :'+u+"px ;left :"+c+'px"></div>');B++;break buckle}}}J.stopPropagation();f()});p.on("dragstop resizestop click",".cell_new",function(j,i){l()});p.on("click","#btn_ajout , #btn_suppr , #btn_vider",function(){l()});function b(i){i=i.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);return"#"+("0"+parseInt(i[1],10).toString(16)).slice(-2)+("0"+parseInt(i[2],10).toString(16)).slice(-2)+("0"+parseInt(i[3],10).toString(16)).slice(-2)}function F(N){var H;a(".cell_new").remove();if(N==""){H=new Array(d);for(var K=0;K<d;K++){H[K]=new Array(C)}for(var K=0;K<d;K++){for(var J=0;J<C;J++){H[K][J]=0}}}else{H=N.split("|");for(var K=0;K<H.length;K++){H[K]=H[K].split(" ")}}m=H;var Q=new Array();for(var K=0;K<12;K++){for(var J=0;J<12;J++){if(m[K][J]!=0&&a.inArray(m[K][J],Q)==-1){var O=K;var M=J;var L=0;var P=0;var I=m[K][J];Q.push(I);while(O+L<12&&m[O+L][M]==I){L++}while(M+P<12&&m[O][M+P]==I){P++}x.append('<div class="cell_new " data-new ="'+I+'" style="top :'+(4+O*48)+"px ;left :"+(4+M*48)+"px ; width :"+(40+((P-1)*48))+"px ; height :"+(40+((L-1)*48))+'px"></div>');B=parseInt(I)+1}}}f();a(".cell_new:first").trigger("resizestop")}function f(){a(".template-e-block-grid").on("click",".cell_new",function(i){a(".selected").removeClass("selected");a(this).addClass("selected");a("#btn_suppr").prop("disabled",false);i.stopPropagation()});a(document).click(function(i){a(".selected").removeClass("selected");a("#btn_suppr").prop("disabled",true)});a(".cell_new").draggable({containment:"#div_grid",grid:[48,48]});a(".cell_new").resizable({containment:"#div_grid",grid:[48,48]})}}});