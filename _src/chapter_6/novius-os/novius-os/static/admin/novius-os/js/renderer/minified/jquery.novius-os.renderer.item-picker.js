/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define("jquery-nos-renderer-item-picker",["jquery","jquery-nos","jquery-ui.widget","link!static/novius-os/admin/novius-os/css/jquery.novius-os.itempicker.css"],function(a){a.widget("nos.nositempicker",{options:{size:64,appdesk:"",crud:"",dataset:{},actions:[],texts:{empty:"No item selected",add:"Pick an item",edit:"Pick another item","delete":"Un-select this item"},defaultThumbnail:""},_create:function(){var b=this,c=b.options;b.$block=a("<div></div>").addClass("nos-itempicker wijmo-wijgrid ui-widget-content").addClass("nos-itempicker-size-"+(c.size=="64"?64:128)).insertAfter(b.element);b.$td=a('<table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td></td></tr></tbody></table>').addClass("nos-itempicker-grid wijmo-wijgrid-root wijmo-wijgrid-table").css({borderCollapse:"separate","-moz-user-select":"-moz-none"}).hover(function(){b.$td.parent().addClass("ui-state-hover")},function(){b.$td.parent().removeClass("ui-state-hover")}).click(function(){}).appendTo(b.$block).find("tbody").addClass("ui-widget-content wijmo-wijgrid-data").find("tr").addClass("wijmo-wijgrid-row ui-widget-content wijmo-wijgrid-datarow").find("td").addClass("wijgridtd");b.$thumb=a("<div></div>").addClass("nos-itempicker-thumb wijmo-wijgrid-innercell").appendTo(b.$td);b.$title=a("<div></div>").addClass("nos-itempicker-title wijmo-wijgrid-innercell").appendTo(b.$td)},_init:function(){var b=this,c=b.options,d=b.element.val();b.element.hide();a.each(c.actions,function(e){this.primary=false});b._actions();if(d){b.$title.text(c.dataset._title);b._itemThumbnail()}else{b.$title.text(c.texts.empty);b._loadImgDefault()}},_actions:function(){var b=this,d=b.options,e=b.element.val(),c;if(b.$buttons){b.$buttons.remove()}if(e){c=a.extend({edit:{action:{},label:d.texts.edit,primary:true,icon:"search"},"delete":{action:{},label:d.texts["delete"],primary:true,icon:"closethick"}},d.actions)}else{c={add:{action:{},label:d.texts.add,primary:true,icon:"plus"}}}b.$buttons=a.nosItemActions(c,d.dataset).appendTo(b.$block);b.$buttons.find("th:first").off("click").click(function(){var g;var h=function(j,k){d.dataset=j;b.element.val(j._id);b.element.trigger("change").trigger("keyup");b._trigger("pick",k,j);g.nosDialog("close");b._init()};var f={};var i=b.element.closest(".nos-dispatcher, body");if(i.data("nosContext")){f.selectedContexts=[i.data("nosContext")]}g=b.element.nosDialog({destroyOnClose:true,contentUrl:d.appdesk+"/index/appdesk_pick",ajaxData:f,ajax:true,title:d.texts.add}).bind("appdesk_pick_"+d.model,function(k,j){h(j,k)}).nosListenEvent({name:d.model,action:"insert"},function(j){a.ajax({method:"GET",url:d.appdesk+"/info/"+j.id,dataType:"json",success:function(k){h(k,j)}})})});if(e){b.$buttons.find("th:eq(1)").off("click").click(function(){d.dataset={};b.element.val("");b._init()})}return b},_itemThumbnail:function(){var b=this,c=b.options;if(c.dataset.thumbnail){b._loadImg(c.dataset.thumbnail)}else{b._loadImgDefault()}return b},_loadImg:function(){var b=this,c=b.options;a("<img />").error(function(){b._loadImgDefault()}).load(function(){var d=a(this);d.prependTo(b.$thumb.empty()).nosOnShow("one",function(){d.css({marginTop:"-"+(d.height()/2)+"px",marginLeft:"-"+(d.width()/2)+"px"})})}).addClass("nos-itempicker-img").attr("src",c.dataset.thumbnail);return b},_loadImgDefault:function(){var b=this,d=b.options;var c=a("<div></div>").addClass("nos-itempicker-img-default").prependTo(b.$thumb.empty());if(d.defaultThumbnail){c.css("background-image","url("+d.defaultThumbnail+")")}return b}});return a});