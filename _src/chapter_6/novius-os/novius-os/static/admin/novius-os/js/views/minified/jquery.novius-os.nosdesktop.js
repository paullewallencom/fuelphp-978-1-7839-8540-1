/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define("jquery-nos-nosdesktop",["jquery-nos","jquery-ui.sortable"],function(a){var b=Modernizr.touch;a.widget("nos.nosdesktop",{options:{launchers:[],reloadUrl:"admin/nos/noviusos/desktop"},launcherWidth:150,launcherHeight:0,grid:{positions:{},set:function(d,c){if(a.isPlainObject(d)){c=d.top;d=d.left}this.positions[d]=this.positions[d]||{};this.positions[d][c]=true},isSet:function(d,c){return this.positions[d]&&this.positions[d][c]},unSet:function(d,c){if(a.isPlainObject(d)){c=d.top;d=d.left}this.positions[d]=this.positions[d]||{};this.positions[d][c]=false}},unPositioned:[],_create:function(){var c=this,e=c.options,d;c.element.nosListenEvent({name:"Nos\\Application"},function(f){a.ajax({url:e.reloadUrl,success:function(g){c.element.parent().empty().append(g)}})});c.maxWidth=c.element.width();a.each(e.launchers,function(){var f=this;a('<a href="#"><span class="icon"><img class="gloss" src="static/novius-os/admin/novius-os/img/64/gloss.png" /><img width="64" /></span><span class="text"></span></a>').addClass("app launcher-"+f.key).data("launcher",f).find("span.icon img:last").attr("src",f.icon).end().find("span.text").html(f.name).end().appendTo(c.element)});c.$launchers=c.element.find(".app");c._calculateLauncherHeight()._positionLaunchers()._positionUnpositioned();if(!b){c._initDrag()}c.$launchers.click(function(f){c._launcherClick(a(this),f)});c.element.closest(".nos-dispatcher").on({resizePanel:function(){if(d){window.clearTimeout(d)}d=window.setTimeout(function(){c.resize()},200)},showPanel:function(){c.resize()}})},_calculateLauncherHeight:function(){var c=this;c.$launchers.each(function(){var d=a(this).outerHeight(true);if(d>c.launcherHeight){c.launcherHeight=d}});return c},_positionLaunchers:function(){var c=this;c.$launchers.each(function(){var d=a(this),e=d.data("launcher");if(e.position&&((e.position.left+1)*c.launcherWidth)<c.maxWidth){c._positionLauncher(d,e.position.left,e.position.top)}else{if(e.position){c.grid.unSet(e.position)}c.unPositioned.push(d)}});return c},_positionUnpositioned:function(){var c=this;if(!c.unPositioned.length){return c}a.each(c.unPositioned,function(){var f=this,g=f.data("launcher"),e=0,d=0;while(1==1){if(c.grid.isSet(e,d)){e++;if(((e+1)*c.launcherWidth)>c.maxWidth){e=0;d++}continue}else{c._positionLauncher(f,e,d);break}}});c.save();c.unPositioned=[];return c},_initDrag:function(){var c=this;c.$launchers.draggable({containement:c.element,grid:[c.launcherWidth,c.launcherHeight],scroll:false,stop:function(h,d){var i=a(this),k=d.position,j=i.data("launcher"),g=parseInt(k.left/c.launcherWidth),f=parseInt(k.top/c.launcherHeight);i.unbind("click");i.one("click",function(e){e.preventDefault();e.stopImmediatePropagation();a(this).click(function(l){c._launcherClick(a(this),l)})});if((k.left+c.launcherWidth)>c.element.width()||c.grid.isSet(g,f)){i.animate({left:(j.position.left*c.launcherWidth)+"px",top:(j.position.top*c.launcherHeight)+"px"},200)}else{c.grid.unSet(j.position);c._positionLauncher(i,g,f);c.save()}}});return c},_positionLauncher:function(f,e,d){var c=this,g=f.data("launcher");g.position={left:e,top:d};f.css({left:(e*c.launcherWidth)+"px",top:(d*c.launcherHeight)+"px",visibility:"visible"});c.grid.set(e,d);return c},_launcherClick:function(f,d){var c=this,g=f.data("launcher");d.preventDefault();if(g.action.tab){g.action.tab=a.extend({app:true,iconSize:32,labelDisplay:false},g.action.tab)}f.nosAction(g.action);return c},resize:function(){var c=this;c.maxWidth=c.element.width();c._positionLaunchers()._positionUnpositioned();return c},save:function(){var c=this,d={};c.$launchers.each(function(){var e=a(this),f=e.data("launcher");d[f.key]={position:f.position}});c.$launchers.nosSaveUserConfig("misc.apps",d);return c}});return a});