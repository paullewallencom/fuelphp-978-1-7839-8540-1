(function(b){function a(d,c,e){return(d>c)&&(d<(c+e))}b.widget("mjs.nestedSortable",b.extend({},b.ui.sortable.prototype,{options:{doNotClear:false,expandOnHover:700,isAllowed:function(e,c,d){return true},isTree:false,listType:"ol",maxLevels:0,protectRoot:false,rootID:null,rtl:false,startCollapsed:false,tabSize:20,branchClass:"mjs-nestedSortable-branch",collapsedClass:"mjs-nestedSortable-collapsed",disableNestingClass:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",expandedClass:"mjs-nestedSortable-expanded",hoveringClass:"mjs-nestedSortable-hovering",leafClass:"mjs-nestedSortable-leaf"},_create:function(){this.element.data("ui-sortable",this.element.data("mjs-nestedSortable"));if(!this.element.is(this.options.listType)){throw new Error("nestedSortable: Please check that the listType option is set to your actual list type")}if(this.options.isTree&&this.options.expandOnHover){this.options.tolerance="intersect"}b.ui.sortable.prototype._create.apply(this,arguments);if(this.options.isTree){var c=this;b(this.items).each(function(){var d=this.item;if(d.children(c.options.listType).length){d.addClass(c.options.branchClass);if(c.options.startCollapsed){d.addClass(c.options.collapsedClass)}else{d.addClass(c.options.expandedClass)}}else{d.addClass(c.options.leafClass)}})}},_destroy:function(){this.element.removeData("mjs-nestedSortable").removeData("ui-sortable");return b.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(f){var p,t,l,e,k=this.options,g=false;this.position=this._generatePosition(f);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-f.pageY<k.scrollSensitivity){this.scrollParent[0].scrollTop=g=this.scrollParent[0].scrollTop+k.scrollSpeed}else{if(f.pageY-this.overflowOffset.top<k.scrollSensitivity){this.scrollParent[0].scrollTop=g=this.scrollParent[0].scrollTop-k.scrollSpeed}}if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-f.pageX<k.scrollSensitivity){this.scrollParent[0].scrollLeft=g=this.scrollParent[0].scrollLeft+k.scrollSpeed}else{if(f.pageX-this.overflowOffset.left<k.scrollSensitivity){this.scrollParent[0].scrollLeft=g=this.scrollParent[0].scrollLeft-k.scrollSpeed}}}else{if(f.pageY-b(document).scrollTop()<k.scrollSensitivity){g=b(document).scrollTop(b(document).scrollTop()-k.scrollSpeed)}else{if(b(window).height()-(f.pageY-b(document).scrollTop())<k.scrollSensitivity){g=b(document).scrollTop(b(document).scrollTop()+k.scrollSpeed)}}if(f.pageX-b(document).scrollLeft()<k.scrollSensitivity){g=b(document).scrollLeft(b(document).scrollLeft()-k.scrollSpeed)}else{if(b(window).width()-(f.pageX-b(document).scrollLeft())<k.scrollSensitivity){g=b(document).scrollLeft(b(document).scrollLeft()+k.scrollSpeed)}}}if(g!==false&&b.ui.ddmanager&&!k.dropBehaviour){b.ui.ddmanager.prepareOffsets(this,f)}}this.positionAbs=this._convertPositionTo("absolute");var q=this.placeholder.offset().top;if(!this.options.axis||this.options.axis!=="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!=="x"){this.helper[0].style.top=this.position.top+"px"}this.hovering=this.hovering?this.hovering:null;this.mouseentered=this.mouseentered?this.mouseentered:false;var j=(this.placeholder[0].parentNode.parentNode&&b(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length)?b(this.placeholder[0].parentNode.parentNode):null,d=this._getLevel(this.placeholder),m=this._getChildLevels(this.helper);var h=document.createElement(k.listType);for(p=this.items.length-1;p>=0;p--){t=this.items[p];l=t.item[0];e=this._intersectsWithPointer(t);if(!e){continue}if(t.instance!==this.currentContainer){continue}if(l!==this.currentItem[0]&&this.placeholder[e===1?"next":"prev"]()[0]!==l&&!b.contains(this.placeholder[0],l)&&(this.options.type==="semi-dynamic"?!b.contains(this.element[0],l):true)){if(!this.mouseentered){b(l).mouseenter();this.mouseentered=true}if(k.isTree&&b(l).hasClass(k.collapsedClass)&&k.expandOnHover){if(!this.hovering){b(l).addClass(k.hoveringClass);var s=this;this.hovering=window.setTimeout(function(){b(l).removeClass(k.collapsedClass).addClass(k.expandedClass);s.refreshPositions();s._trigger("expand",f,s._uiHash())},k.expandOnHover)}}this.direction=e==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(t)){b(l).mouseleave();this.mouseentered=false;b(l).removeClass(k.hoveringClass);this.hovering&&window.clearTimeout(this.hovering);this.hovering=null;if(k.protectRoot&&!(this.currentItem[0].parentNode==this.element[0]&&l.parentNode!=this.element[0])){if(this.currentItem[0].parentNode!=this.element[0]&&l.parentNode==this.element[0]){if(!b(l).children(k.listType).length){l.appendChild(h);k.isTree&&b(l).removeClass(k.leafClass).addClass(k.branchClass+" "+k.expandedClass)}var r=this.direction==="down"?b(l).prev().children(k.listType):b(l).children(k.listType);if(r[0]!==undefined){this._rearrange(f,null,r)}}else{this._rearrange(f,t)}}else{if(!k.protectRoot){this._rearrange(f,t)}}}else{break}this._clearEmpty(l);this._trigger("change",f,this._uiHash());break}}var n=this.placeholder[0].previousSibling?b(this.placeholder[0].previousSibling):null;if(n!=null){while(n[0].nodeName.toLowerCase()!="li"||n[0]==this.currentItem[0]||n[0]==this.helper[0]){if(n[0].previousSibling){n=b(n[0].previousSibling)}else{n=null;break}}}var c=this.placeholder[0].nextSibling?b(this.placeholder[0].nextSibling):null;if(c!=null){while(c[0].nodeName.toLowerCase()!="li"||c[0]==this.currentItem[0]||c[0]==this.helper[0]){if(c[0].nextSibling){c=b(c[0].nextSibling)}else{c=null;break}}}this.beyondMaxLevels=0;if(j!=null&&c==null&&!(k.protectRoot&&j[0].parentNode==this.element[0])&&(k.rtl&&(this.positionAbs.left+this.helper.outerWidth()>j.offset().left+j.outerWidth())||!k.rtl&&(this.positionAbs.left<j.offset().left))){j.after(this.placeholder[0]);if(k.isTree&&j.children(k.listItem).children("li:visible:not(.ui-sortable-helper)").length<1){j.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass)}this._clearEmpty(j[0]);this._trigger("change",f,this._uiHash())}else{if(n!=null&&!n.hasClass(k.disableNestingClass)&&(n.children(k.listType).length&&n.children(k.listType).is(":visible")||!n.children(k.listType).length)&&!(k.protectRoot&&this.currentItem[0].parentNode==this.element[0])&&(k.rtl&&(this.positionAbs.left+this.helper.outerWidth()<n.offset().left+n.outerWidth()-k.tabSize)||!k.rtl&&(this.positionAbs.left>n.offset().left+k.tabSize))){this._isAllowed(n,d,d+m+1);if(!n.children(k.listType).length){n[0].appendChild(h);k.isTree&&n.removeClass(k.leafClass).addClass(k.branchClass+" "+k.expandedClass)}if(q&&(q<=n.offset().top)){n.children(k.listType).prepend(this.placeholder)}else{n.children(k.listType)[0].appendChild(this.placeholder[0])}this._trigger("change",f,this._uiHash())}else{this._isAllowed(j,d,d+m)}}this._contactContainers(f);if(b.ui.ddmanager){b.ui.ddmanager.drag(this,f)}this._trigger("sort",f,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(c,d){if(this.beyondMaxLevels){this.placeholder.removeClass(this.options.errorClass);if(this.domPosition.prev){b(this.domPosition.prev).after(this.placeholder)}else{b(this.domPosition.parent).prepend(this.placeholder)}this._trigger("revert",c,this._uiHash())}b("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass);this.mouseentered=false;this.hovering&&window.clearTimeout(this.hovering);this.hovering=null;b.ui.sortable.prototype._mouseStop.apply(this,arguments)},_intersectsWithSides:function(f){var g=this.options.isTree?0.8:0.5;var d=a(this.positionAbs.top+this.offset.click.top,f.top+(f.height*g),f.height),i=a(this.positionAbs.top+this.offset.click.top,f.top-(f.height*g),f.height),e=a(this.positionAbs.left+this.offset.click.left,f.left+(f.width/2),f.width),c=this._getDragVerticalDirection(),h=this._getDragHorizontalDirection();if(this.floating&&h){return((h=="right"&&e)||(h=="left"&&!e))}else{return c&&((c=="down"&&d)||(c=="up"&&i))}},_contactContainers:function(c){if(this.options.protectRoot&&this.currentItem[0].parentNode==this.element[0]){return}b.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(e,f){b.ui.sortable.prototype._clear.apply(this,arguments);for(var c=this.items.length-1;c>=0;c--){var d=this.items[c].item[0];this._clearEmpty(d)}},serialize:function(d){var f=b.extend({},this.options,d),c=this._getItemsAsjQuery(f&&f.connected),e=[];b(c).each(function(){var h=(b(f.item||this).attr(f.attribute||"id")||"").match(f.expression||(/(.+)[-=_](.+)/)),g=(b(f.item||this).parent(f.listType).parent(f.items).attr(f.attribute||"id")||"").match(f.expression||(/(.+)[-=_](.+)/));if(h){e.push(((f.key||h[1])+"["+(f.key&&f.expression?h[1]:h[2])+"]")+"="+(g?(f.key&&f.expression?g[1]:g[2]):f.rootID))}});if(!e.length&&f.key){e.push(f.key+"=")}return e.join("&")},toHierarchy:function(f){var g=b.extend({},this.options,f),d=g.startDepthCount||0,e=[];b(this.element).children(g.items).each(function(){var h=c(this);e.push(h)});return e;function c(i){var j=(b(i).attr(g.attribute||"id")||"").match(g.expression||(/(.+)[-=_](.+)/));if(j){var h={id:j[2]};if(b(i).children(g.listType).children(g.items).length>0){h.children=[];b(i).children(g.listType).children(g.items).each(function(){var k=c(this);h.children.push(k)})}return h}}},toArray:function(e){var h=b.extend({},this.options,e),c=h.startDepthCount||0,d=[],f=1;if(!h.excludeRoot){d.push({item_id:h.rootID,parent_id:null,depth:c,left:f,right:(b(h.items,this.element).length+1)*2});f++}b(this.element).children(h.items).each(function(){f=g(this,c+1,f)});d=d.sort(function(j,i){return(j.left-i.left)});return d;function g(l,n,m){var k=m+1,o,j;if(b(l).children(h.listType).children(h.items).length>0){n++;b(l).children(h.listType).children(h.items).each(function(){k=g(b(this),n,k)});n--}o=(b(l).attr(h.attribute||"id")).match(h.expression||(/(.+)[-=_](.+)/));if(n===c+1){j=h.rootID}else{var i=(b(l).parent(h.listType).parent(h.items).attr(h.attribute||"id")).match(h.expression||(/(.+)[-=_](.+)/));j=i[2]}if(o){d.push({item_id:o[2],parent_id:j,depth:n,left:m,right:k})}m=k+1;return m}},_clearEmpty:function(c){var e=this.options;var d=b(c).children(e.listType);if(d.length&&!d.children().length&&!e.doNotClear){e.isTree&&b(c).removeClass(e.branchClass+" "+e.expandedClass).addClass(e.leafClass);d.remove()}else{if(e.isTree&&d.length&&d.children().length&&d.is(":visible")){b(c).removeClass(e.leafClass).addClass(e.branchClass+" "+e.expandedClass)}else{if(e.isTree&&d.length&&d.children().length&&!d.is(":visible")){b(c).removeClass(e.leafClass).addClass(e.branchClass+" "+e.collapsedClass)}}}},_getLevel:function(c){var e=1;if(this.options.listType){var d=c.closest(this.options.listType);while(d&&d.length>0&&!d.is(".ui-sortable")){e++;d=d.parent().closest(this.options.listType)}}return e},_getChildLevels:function(e,g){var d=this,f=this.options,c=0;g=g||0;b(e).children(f.listType).children(f.items).each(function(h,i){c=Math.max(d._getChildLevels(i,g+1),c)});return g?c+1:c},_isAllowed:function(c,g,e){var f=this.options,d=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels");if(!f.isAllowed(this.placeholder,c,this.currentItem)){this.placeholder.addClass(f.errorClass);if(d<e&&d!=0){this.beyondMaxLevels=e-d}else{this.beyondMaxLevels=1}}else{if(d<e&&d!=0){this.placeholder.addClass(f.errorClass);this.beyondMaxLevels=e-d}else{this.placeholder.removeClass(f.errorClass);this.beyondMaxLevels=0}}}}));b.mjs.nestedSortable.prototype.options=b.extend({},b.ui.sortable.prototype.options,b.mjs.nestedSortable.prototype.options)})(jQuery);