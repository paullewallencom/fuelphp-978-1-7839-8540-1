(function(a){a.widget("ui.inputFileThumb",{options:{width:58,height:58,file:"",title:"",description:"",extensions:[],deleteInput:false,allowDelete:false,displayExtension:true,orientation:"",classes:"",texts:{add:"Add",edit:"Edit","delete":"Delete",wrongExtension:"This extension is not allowed"},extensionsType:{image:["gif","jpg","jpeg","png","bmp"]},wrongExtension:function(b,c){alert(c.message)},visualize:function(b,c){if(c.file){window.open(c.file)}},"delete":null,changed:null,choose:null},popupOpened:false,created:false,_create:function(){var b=this,c=b.options;if(b.element.is(":input")){if(b.element.is(":file")){b.uiInputFile=b.element}else{b.element.hide()}b.uiWidget=a("<span></span>").insertAfter(b.element);b.element.appendTo(b.uiWidget)}else{b.uiWidget=b.element}b.uiWidget.addClass("ui-widget ui-inputfilethumb");b._eventsHandlers();b.uiThumb=a("<span><span></span></span>").addClass("ui-widget-content ui-corner-all ui-inputfilethumb-thumb").mouseenter(function(){b.show()}).appendTo(b.uiWidget).find("span").addClass("ui-inputfilethumb-thumb-bg ui-corner-all").end();b.uiHover=a("<div></div>").addClass("ui-widget-content ui-corner-all ui-inputfilethumb-hover").mouseleave(function(){if(!a.browser.webkit||!b.popupOpened){b.hide()}}).appendTo(b.uiWidget);b.uiFileThumb=a("<span></span>").addClass("ui-inputfilethumb-filethumb").appendTo(b.uiHover);b.uiFileWrapper=a("<div></div>").addClass("ui-inputfilethumb-filewrapper").appendTo(b.uiHover);b.uiFileTitle=a("<h4></h4>").addClass("ui-inputfilethumb-filetitle").appendTo(b.uiFileWrapper);b.uiFileDescription=a("<p></p>").addClass("ui-inputfilethumb-filedescription").appendTo(b.uiFileWrapper);b.uiFileActions=a("<div></div>").addClass("ui-inputfilethumb-fileactions").appendTo(b.uiFileWrapper);b.uiAddFile=a("<span></span>").addClass("ui-inputfilethumb-fileaction").appendTo(b.uiFileActions).button({icons:{primary:"ui-icon-plusthick"}}).click(function(d){b.choose(d)});b.uiEditFile=a("<span></span>").addClass("ui-inputfilethumb-fileaction").appendTo(b.uiFileActions).button({icons:{primary:"ui-icon-pencil"}}).click(function(d){b.choose(d)});b.uiDeleteInput=a('<input type="hidden" value="" />').appendTo(b.uiFileActions);b.uiDeleteFile=a('<button type="button"></button>').addClass("ui-inputfilethumb-fileaction").appendTo(b.uiFileActions).button({icons:{primary:"ui-icon-closethick"}}).click(function(d){b["delete"](d)});if(b.element.is(":input")){b.element.appendTo(b.uiHover).click(function(d){b.choose(d)})}},_init:function(){var b=this,d=b.options,c=d.file;if(b.uiInputFile){b.uiInputFile.appendTo(b.uiWidget);c=c||b.uiInputFile.val()}d.title=d.title||b.element.attr("title")||b.element.attr("name");b.uiFileTitle.text(d.title);b.uiFileDescription.text(d.description);b.uiAddFile.button("option","label",d.texts.add);b.uiEditFile.button("option","label",d.texts.edit);b.uiDeleteInput.attr("name",d.deleteInput||"");b.uiDeleteFile.button("option","label",d.texts["delete"])[d.deleteInput||d.allowDelete?"show":"hide"]();b.uiWidget[d.disabled?"addClass":"removeClass"]("ui-state-disabled");b._change(c)},destroy:function(){var b=this;if(b.element!==b.uiWidget){b.element.insertBefore(b.uiWidget)}b._eventsHandlers(true);b.uiWidget.remove();return b},_setOptions:function(c){var b=this;a.each(c,function(d,e){a.Widget.prototype._setOption.call(b,d,e)});b._init()},_setOption:function(c,d){var b=this;a.Widget.prototype._setOption.apply(b,arguments);b._init()},_change:function(c){var b=this,e=b.options,d=false;if(c){d=b._checkExtension(c);if(d===false){b["delete"]();return}if(b.uiInputFile){b.uiInputFile.appendTo(b.uiEditFile)}b.uiAddFile.hide();b.uiEditFile.show();if(e.deleteInput){b.uiDeleteInput.val("")}if(e.deleteInput||e.allowDelete){b.uiDeleteFile.show()}}else{if(b.uiInputFile){b.uiInputFile.appendTo(b.uiAddFile)}b.uiAddFile.show();b.uiEditFile.hide();if(e.allowDelete){b.element.val("")}if(e.deleteInput||e.allowDelete){b.uiDeleteFile.hide()}}b.uiFileActions[e.disabled?"hide":"show"]();b._icon(d,c);return b},_checkExtension:function(c){var b=this,f=b.options,d="";var e=c.match(/.+\.(\w{2,4})(\?|$)/gi);if(a.isArray(e)&&e.length){d=RegExp.$1}if(f.extensions.length&&a.inArray(d.toLowerCase(),f.extensions)===-1){b._trigger("wrongExtension",null,{extension:d,authorized:f.extensions,message:f.texts.wrongExtension});return false}return d},_icon:function(d,c){var b=this,e=b.options;if(c&&a.inArray(d,e.extensionsType.image)!==-1){a('<img src="'+c+'" />').error(function(){a(this).remove();b._iconByExtension(d)}).load(function(){b.uiThumb.empty().css({"text-align":"center",cursor:"pointer"}).width(e.width).height(e.height);var g={width:b.uiThumb.innerWidth(),height:b.uiThumb.innerHeight()},h=a(this),i=h.width(),f=h.height();if(f>i){if(i>g.width){h.width(g.width+"px")}}else{if(f>g.height){h.height(g.height+"px")}else{h.css("margin-top",(g.height-f)/2+"px")}}h.css("display","inline").appendTo(b.uiThumb)}).hide().appendTo("body")}else{b._iconByExtension(d)}return b},_iconByExtension:function(d){var b=this,e=b.options,c=e.classes;b.uiThumb.empty().append('<span class="ui-inputfilethumb-thumb-bg ui-corner-all"></span>').css({"text-align":"right",cursor:"default"});if(!c){a.each(e.extensionsType,function(i,g){var h=false;if(e.extensions.length>0){h=true;a.each(e.extensions,function(j,k){if(a.inArray(k,g)===-1){h=false;return false}return true})}if(h){c=i;return false}else{if(a.inArray(d,g)!==-1){c=i;return false}}return true})}var f=b.uiThumb.find(".ui-inputfilethumb-thumb-bg").addClass(c+(d?" ui-inputfilethumb-extension-on":""));if(e.displayExtension){if(d!==false){f.append('<span class="ui-corner-all '+d+'">'+d+"</span>")}else{if(e.extensions.length==1){f.append('<span class="ui-corner-all '+e.extensions[0]+'">'+e.extensions[0]+"</span>")}}}f.css("line-height",e.height+"px").add(b.uiThumb).width(e.width).height(e.height);return b},_empty:function(){var c=this,e=c.options;if(c.uiInputFile){var b=a("<span></span>").insertAfter(c.uiInputFile);var d=a("<form></form>").appendTo("body");c.uiInputFile.appendTo(d);d[0].reset();c.uiInputFile.insertAfter(b);b.remove()}return c._change("")},_eventsHandlers:function(d){d=d||false;var c=this;if(c.uiInputFile){var f=function(){c.uiInputFile.parent().addClass("ui-state-hover")},b=function(){c.uiInputFile.parent().removeClass("ui-state-hover")},g=function(h){c._change(c.uiInputFile.val()).hide()._trigger("changed")},e=function(h){if(a.browser.webkit&&!c.popupOpened){c.popupOpened=setTimeout(function(){a("body").one("mousemove",function(){c.popupOpened=false;c.hide()})},500)}};c.uiInputFile[d?"off":"on"]({mouseenter:f,mouseleave:b,change:g,click:e})}return c},choose:function(c){var b=this,d=b.options;b._trigger("choose",c);return b},"delete":function(c){var b=this,d=b.options;if(false===b._trigger("delete",c)){c.stopImmediatePropagation();return false}b.uiDeleteInput.val("1");d.file="";return b._empty().hide()},show:function(){var b=this,g=b.options,i=b.uiThumb.clone(false).addClass("ui-state-active").appendTo(b.uiFileThumb).bind("click",function(j){b._trigger("visualize",j,{file:g.file})}),h=b.uiThumb.offset(),f=h.left,e=h.top,c=b.uiThumb.offsetParent().not("body");b.uiHover.css({top:0,left:0,opacity:0}).show();if(c.size()){h=c.offset();f-=h.left;e-=h.top}var d={left:parseInt(b.uiHover.css("padding-left").replace("px",""))+parseInt(b.uiHover.css("border-left-width").replace("px","")),top:parseInt(b.uiHover.css("padding-top").replace("px",""))+parseInt(b.uiHover.css("border-top-width").replace("px","")),right:parseInt(b.uiHover.css("padding-right").replace("px",""))+parseInt(b.uiHover.css("border-right-width").replace("px",""))};if(g.orientation=="rtl"||(f-d.left+b.uiHover.outerWidth())>a(window).width()){b.uiHover.addClass("ui-inputfilethumb-rtl").css({top:e-d.top,left:f+d.right+b.uiThumb.outerWidth()-b.uiHover.outerWidth()})}else{b.uiHover.removeClass("ui-inputfilethumb-rtl").css({top:e-d.top,left:f-d.left})}if(a.fn.bgiframe){b.uiHover.bgiframe()}b.uiHover.css("opacity",1);return b},hide:function(){var b=this,c=b.options;b.uiHover.find(".ui-inputfilethumb-thumb").remove().end().hide();return b}})})(jQuery);