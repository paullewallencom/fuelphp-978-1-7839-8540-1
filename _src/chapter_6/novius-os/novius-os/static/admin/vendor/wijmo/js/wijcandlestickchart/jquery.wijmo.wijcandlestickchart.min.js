var __extends=this.__extends||function(e,t){function n(){this.constructor=e}n.prototype=t.prototype,e.prototype=new n},wijmo;(function(e){(function(e){var t="wijcandlestickchart",n="ohlc",r="candlestick",i="hl",s="stroke-width",o=function(){function e(e){this.init(e)}return e.prototype.init=function(e){var t=[],n={},r,i;$.each(e,function(e,n){var r=$.toOADate(n);$.inArray(r,t)===-1&&t.push(r)}),this.count=r=t.length,this.times=t=t.sort(),this.timeDic=n;if(r<2){this.max=t[0]||0,this.min=t[0]||0,this.unit=864e5,r===1&&(n[t[0]]=0);return}for(i=0;i<r;i++)n[t[i]]=i;this._calculateUnit(),this.max=t[this.count-1],this.min=t[0]},e.prototype._calculateUnit=function(){var e=Number.MAX_VALUE,t=1;for(;t<this.count;t++)e=Math.min(e,this.times[t]-this.times[t-1]);this.unit=e},e.prototype.getOATime=function(e){var t=this.count,n=this.times,r;return e<0?this.min+e*this.unit:e>t-1?this.max+(e-t+1)*this.unit:(r=parseInt(e),n[r]+(e-r)*this.unit)},e.prototype.getTime=function(e){return $.fromOADate(this.getOATime(e))},e.prototype.getTimeIndex=function(e){var t=$.toOADate(e),n;return t>this.max?this.count-1+(t-this.max)/this.unit:t<this.min?(t-this.min)/this.unit:this.timeDic&&this.timeDic[t]!=null?this.timeDic[t]:($.each(this.times,function(e,r){if(r>t)return n=e-1,!1}),n+(t-this.times[n])/this.unit)},e.prototype.getCount=function(){return this.times.length},e.prototype.dispose=function(){this.times=null,this.timeDic=null},e}();e.datetimeUtil=o;var u=function(t){function s(){t.apply(this,arguments)}return __extends(s,t),s.prototype._paintChartArea=function(){var e=this.options;if(this._isSeriesListDataEmpty())return;$.each(e.seriesList,function(e,t){var n=t.data;n.y=[].concat(n.high).concat(n.low)}),t.prototype._paintChartArea.call(this),$.each(e.seriesList,function(e,t){delete t.data.y})},s.prototype._checkSeriesDataEmpty=function(e){var t=this.options.type,i=e.data,s=this._checkEmptyData;if(!i||s(i.x)||s(i.high)||s(i.low))return!0;if(t===n||t===r)if(s(i.open)||s(i.close))return!0;return!1},s.prototype._getLegendStyle=function(e){var t=e.highLow;return t?(t=$.extend({},t),delete t.width,delete t.height,t.stroke||(t.stroke=t.fill),t):e},s.prototype._showHideSeries=function(e,t){var n=["highLow","open","close","path","high","low","openClose"];$.each(e,function(e,r){$.each(n,function(e,n){r[n]&&r[n][t]()}),r.path&&$(r.path.node).data("wijchartDataObj")&&($(r.path.node).data("wijchartDataObj").visible=t==="show")})},s.prototype._showSerieEles=function(e){this._showHideSeries(e,"show")},s.prototype._hideSerieEles=function(e){this._showHideSeries(e,"hide")},s.prototype._paintPlotArea=function(){var e=this.options,t=new a(this.chartElement,{canvas:this.canvas,bounds:this.canvasBounds,tooltip:this.tooltip,widgetName:this.widgetName,axis:e.axis,seriesList:e.seriesList,seriesStyles:e.seriesStyles,seriesHoverStyles:e.seriesHoverStyles,seriesTransition:e.seriesTransition,showChartLabels:e.showChartLabels,textStyle:e.textStyle,chartLabelStyle:e.chartLabelStyle,chartLabelFormatString:e.chartLabelFormatString,shadow:e.shadow,disabled:e.disabled,animation:e.animation,culture:this._getCulture(),type:e.type,wijCSS:e.wijCSS,mouseDown:$.proxy(this._mouseDown,this),mouseUp:$.proxy(this._mouseUp,this),mouseOver:$.proxy(this._mouseOver,this),mouseOut:$.proxy(this._mouseOut,this),mouseMove:$.proxy(this._mouseMove,this),click:$.proxy(this._click,this),timeUtil:this.timeUtil,candlestickFormatter:e.candlestickFormatter,widget:this});t.render()},s.prototype._paintTooltip=function(){var e=this.chartElement.data("fields"),n;t.prototype._paintTooltip.call(this),this.tooltip&&e&&e.trackers&&(n=e.trackers,this.tooltip.setTargets(n),this.tooltip.setOptions({relatedElement:n[0]}))},s.prototype._getTooltipText=function(e,t){var n=$(t.node).data("wijchartDataObj"),r={data:n,label:n.label,x:n.x,high:n.high,low:n.low,open:n.open,close:n.close,target:t,fmt:e};return $.proxy(e,r)()},s.prototype._setDefaultTooltipText=function(e){var t=this.options.type,n;return n=e.label+" - "+Globalize.format(e.x,"d")+"\n High:"+e.high+"\n Low:"+e.low,t!==i&&(n+="\n Open:"+e.open+"\n Close:"+e.close+""),n},s.prototype._setDefaultFill=function(e,t){function r(e,t){var n=e[t]||{};n.fill||(n.fill=e.fill),e[t]=n}function s(e,t){$.isArray(t)?$.each(t,function(t,n){r(e,n)}):r(e,t)}e===i?s(t,"highLow"):e===n?s(t,["open","close","highLow"]):s(t,["fallingClose","risingClose","unchangeClose","highLow"])},s.prototype._setDefaultCandlestickStyle=function(){var e=this,t=this.options,n=t.type,r=this._getDefFill();$.each(t.seriesStyles,function(t,i){i.fill||(i.fill=r[t]),e._setDefaultFill(n,i)}),r=null},s.prototype._handleChartStyles=function(){t.prototype._handleChartStyles.call(this),this._setDefaultCandlestickStyle()},s.prototype._create=function(){this._handleChartStyles(),this.bindXData=!1,this._handleXData(),t.prototype._create.call(this),this.chartElement.addClass(this.options.wijCSS.wijCandlestickChart)},s.prototype._setOption=function(e,n){e==="axis"&&this._handleMaxMinInAxis(n),t.prototype._setOption.call(this,e,n)},s.prototype._seriesListSeted=function(){this.timeUtil.dispose(),this.timeUtil=null,this._handleXData()},s.prototype._handleMaxMinInAxis=function(e){var t=this,n,r=this.options.axis,i=function(e){return t._isDate(e)?t.timeUtil.getTimeIndex(e):t.timeUtil.getTimeIndex($.fromOADate(e))};e&&e.x&&(n=e.x,$.each(["max","min"],function(e,t){if(!r||!r.x||r.x[t]!==n[t])n[t]=i(n[t])}))},s.prototype._handleXData=function(){var e=this,t=this.options,n=t.seriesList=$.arrayClone(t.seriesList),r=[],i=!1,s=function(e){return e.data&&e.data.x},u=function(t){var n=t.data.x;$.each(n,function(t,r){e._isDate(r)||(n[t]=e.timeUtil.getTime(r))})};if(this.timeUtil&&!this.bindXData)return;this.bindXData=!1,$.each(n,function(e,t){s(t)&&$.isArray(t.data.x)&&(r=r.concat(t.data.x))}),this.timeUtil&&($.each(r,function(t,n){if(e._isDate(n))return i=!0,!1}),i&&(r=[],$.each(n,function(e,t){s(t)&&(u(t),r=r.concat(t.data.x))}),this.timeUtil.dispose(),this.timeUtil=null)),this.timeUtil||(this.timeUtil=new o(r)),$.each(n,function(t,n){s(n)&&$.isArray(n.data.x)&&(n.data.x=$.map(n.data.x,function(t,n){return e.timeUtil.getTimeIndex(t)}))})},s.prototype._bindData=function(){t.prototype._bindData.call(this),this._handleXData()},s.prototype._bindSeriesData=function(e,n,r){var i=this,s=n.data;t.prototype._bindSeriesData.call(this,e,n,r),s.x&&$.isArray(s.x)&&(this.bindXData=!0),$.each(["high","low","open","close"],function(t,n){var r=s[n];r&&r.bind&&(s[n]=i._getBindData(e,r.bind))})},s.prototype.destroy=function(){var e=this.chartElement;e.removeClass(this.options.wijCSS.wijCandlestickChart),t.prototype.destroy.call(this),this.timeUtil&&this.timeUtil.dispose(),e.data("fields",null)},s.prototype.getCandlestick=function(e){var t=this.chartElement.data("fields");return t&&t.chartElements&&t.chartElements.candlestickEles?t.chartElements.candlestickEles[e]||null:null},s.prototype._clearChartElement=function(){var e=this.options,n=this.chartElement.data("fields"),r,i;n&&n.chartElements&&(r=n.chartElements,i=r.candlestickEles,$.each(i,function(e,t){$.each(t,function(e,n){n&&n[0]&&n.wijRemove(),t[e]=null}),i[e]=null}),r.candlestickEles=null,r.group&&r.group.wijRemove(),r.group=null,n.trackers&&n.trackers.wijRemove(),n.trackers=null),t.prototype._clearChartElement.call(this)},s.prototype._calculateParameters=function(e,n){t.prototype._calculateParameters.call(this,e,n);if(e.id==="x"){var r=n.unitMinor,i=n.autoMin,s=n.autoMax,o=this._getCandlestickAdjustment(e,r);i&&(e.min-=o),s&&(e.max+=o),this._calculateMajorMinor(n,e)}},s.prototype._calculateMajorMinor=function(n,r){r.id==="x"&&(!n.annoFormatString||n.annoFormatString.length===0?r.annoFormatString=e.ChartDataUtil.getTimeDefaultFormat(this.timeUtil.getOATime(r.max),this.timeUtil.getOATime(r.min)):r.annoFormatString=n.annoFormatString),t.prototype._calculateMajorMinor.call(this,n,r)},s.prototype._getCandlestickAdjustment=function(e,t){var n=0,r;return $.each(this.options.seriesList,function(e,t){t.data&&t.data.x&&$.isArray(t.data.x)&&(n=Math.max(t.data.x.length,n))}),r=(e.max-e.min)/n,r===0?r=t:t<r&&t!==0&&(r=Math.floor(r/t)*t),r},s.prototype._getXTickText=function(e){return this.timeUtil.getCount()===0?"":this.timeUtil.getTime(e)},s.prototype._adjustTickValuesForCandlestickChart=function(e){var n=this,r=this.options.axis.x.annoMethod==="valueLabels",i=[];return r&&e&&$.isArray(e)?($.each(e,function(e,t){i[e]=n.timeUtil.getTimeIndex($.fromOADate(t))}),i):t.prototype._adjustTickValuesForCandlestickChart.call(this,e)},s.prototype._getTickTextForCalculateUnit=function(e,n,r){return n.id==="x"?Globalize.format(this._getXTickText(e),n.annoFormatString,this._getCulture()):t.prototype._getTickTextForCalculateUnit.call(this,e,n,r)},s}(e.wijchartcore);e.wijcandlestickchart=u;var a=function(){function e(e,t){this.element=e,this.options=t,this.bounds=t.bounds,this.width=this.bounds.endX-this.bounds.startX,this.height=this.bounds.endY-this.bounds.startY,this.type=t.type,this.timeUtil=t.timeUtil,this.trackers=t.canvas.set(),this.isHover=!1}return e.prototype._paintCandlestickElements=function(e,t,n){var r=e.data,s=Math.min(r.x.length,r.high.length,r.low.length),o=this.options.wijCSS,u=$.extend({candlestickType:this.type,visible:!0},e),a=[],f=this.options.widget,l,c,h,p,d,v;u.type="candlestick",r.open&&r.close&&(s=Math.min(s,r.open.length,r.close.length)),l=this.width/s;for(c=0;c<s;c++)h=this._paintCandlestickGraphic(r,c,l,t,n),d=$.extend({},u),h.path&&(p=$(h.path.node),$.wijraphael.addClass(p,o.canvasObject+" "+o.candlestickChart+" "+o.candlestickChartTracker),p.css("opacity",0),this.type!==i&&$.extend(d,{open:r.open[c],close:r.close[c]}),$.extend(d,{high:r.high[c],low:r.low[c],index:c,x:this.timeUtil.getTime(r.x[c]),candlestickEles:h,style:t,hoverStyle:n}),p.data("wijchartDataObj",d)),e.visible===!1&&$.each(h,function(e,t){t&&t.hide&&t.hide()}),a.push(h),f.dataPoints=f.dataPoints||{},f.pointXs=f.pointXs||[],v=h.x,f.dataPoints[v.toString()]||(f.dataPoints[v.toString()]=[],f.pointXs.push(v)),f.dataPoints[v.toString()].push(d);return a},e.prototype._unbindLiveEvents=function(){var e=this.options.widgetName;this.element.off("."+e,".wijcandlestickchart")},e.prototype._bindLiveEvents=function(){function i(e){var t=$(e.target);return t.data("wijchartDataObj")}function s(e,n,i){var s={mouseover:t.mouseOver,mouseout:t.mouseOut,mousedown:t.mouseDown,mouseup:t.mouseUp,mousemove:t.mouseMove,click:t.click};if($.isFunction(s[e]))return s[e].call(r,n,i)}var e=this,t=this.options,n="",r=this.element;$.support.isTouchEnabled&&$.support.isTouchEnabled()&&(n="wij"),$.each(["mouseover","mouseout","mousedown","mouseup","mousemove","click"],function(r,o){e.element.on(n+o+"."+t.widgetName,".wijcandlestickchart",function(n){if(t.disabled)return;var r=i(n);s(o,n,r)!==!1&&(o==="mouseover"||o==="mouseout")&&e["_"+o](r),r=null})})},e.prototype._setCandlestickStyleForHover=function(e,t,n,r){var i=function(e,t){e&&t&&e.attr(t)};i(e.highLow,t.highLow),i(e.open,t.open),i(e.close,t.close),i(e.high,t.highLow),i(e.low,t.highLow),n!==undefined&&r!==undefined&&(n>r?i(e.openClose,t.fallingClose):n<r?i(e.openClose,t.risingClose):i(e.openClose,t.unchangeClose))},e.prototype._mouseover=function(e){e.hoverStyle&&(this.isHover=!0,this._setCandlestickStyleForHover(e.candlestickEles,e.hoverStyle,e.open,e.close))},e.prototype._mouseout=function(e){var t=e.style;this.isHover&&(this._setCandlestickStyleForHover(e.candlestickEles,t,e.open,e.close),this._formatCandlestick({high:e.high,low:e.low,open:e.open,close:e.close,hlStyle:t.highLow,oStyle:t.open,cStyle:t.close,index:e.index,eles:e.candlestickEles,fallingCloseStyle:t.fallingClose,risingCloseStyle:t.risingClose,unchangeCloseStyle:t.unchangeClose}),this.isHover=!1)},e.prototype._paintCandlestickGraphic=function(e,t,o,u,a){function G(e){return e?{fill:e.fill,stroke:e.stroke}:null}var f=this.options,l=e.x[t],c=e.high[t],h=e.low[t],p=e.open?e.open[t]:0,d=e.close?e.close[t]:0,v=this.bounds.startX,m=this.bounds.endY,g=this.type!==i,y=f.axis,b=y.x,w=y.y,E=b.min,S=w.min,x=b.max,T=w.max,N=0,C=0,k=this.width/(x-E),L=this.height/(T-S),A,O,M,_,N,C,D,P,H,B,j,F,I,q,R,U,z,W,X,V,J,K,Q;return M=u.open,O=u.close,A=u.highLow,z=u.fallingClose,W=u.risingClose,V=u.unchangeClose,_=A[s]||0,j=(l-E)*k+this.bounds.startX,F=m-(c-S)*L,I=j,q=m-(h-S)*L,g&&(this.type===n?(N=M[s]||0,C=O[s]||0):(p>d?(N=C=z[s]||0,K=z.width||0,J=G(z),Q=z):p===d?(N=C=V[s]||0,K=V.width||0,J=G(V),Q=V):(N=C=W[s]||0,K=W.width||0,J=G(W),Q=W),A=$.extend({},J,A),o-=(N+C)/2,o<2&&(o=2)),U=o/2*.8,this.type===r&&(U=Math.min(K/2,U)),U<1&&(U=1),D=j-U,P=m-(p-S)*L,H=j+U,B=m-(d-S)*L,P=Math.max(P,F+N/2),P=Math.min(P,q-N/2),B=Math.max(B,F+C/2),B=Math.min(B,q-C/2)),this.type===n?(R=this._paintOHLC({h:{x:j,y:F},l:{x:I,y:q},o:{x:D,y:P},c:{x:H,y:B}}),R.open.attr(M),R.close.attr(O)):this.type===i?R=this._paintHL({h:{x:j,y:F},l:{x:I,y:q}}):(R=this._paintCandlestick({h:{x:j,y:F},l:{x:I,y:q},o:{x:D,y:P},c:{x:H,y:B}}),R.high.attr(A),R.low.attr(A),R.openClose.attr(Q)),R.highLow&&R.highLow.attr(A),this._formatCandlestick({high:c,low:h,open:p,close:d,hlStyle:A,oStyle:M,cStyle:O,index:t,eles:R,fallingCloseStyle:z,risingCloseStyle:W,unchangeCloseStyle:V}),R.path.attr({"stroke-width":Math.max(K||1,C||1,_||1,N||1),fill:"#000"}),this.trackers.push(R.path),R.x=$.round(j),u.highLow=A,R},e.prototype._formatCandlestick=function(e){var t=this.options.candlestickFormatter,i=e.index,s=e.high,o=e.low,u=e.open,a=e.close,f=e.hlStyle,l=e.oStyle,c=e.cStyle,h=e.fallingCloseStyle,p=e.risingCloseStyle,d=e.unchangeCloseStyle,v=this.type,m,g;t&&(m={high:s,low:o},g={highLow:f},v===n?($.extend(m,{open:u,close:a}),$.extend(g,{open:l,close:c})):v===r&&($.extend(m,{open:u,close:a}),$.extend(g,{fallingClose:h,risingClose:p,unchangeClose:d})),t.call(this,{data:m,eles:e.eles,style:g}))},e.prototype._paintTracker=function(e,t){var n=[],r=[],i,s,o,u;return $.each(e,function(e,t){n.push(t.x),r.push(t.y)}),i=Math.max.apply(null,n),s=Math.min.apply(null,n),o=Math.max.apply(null,r),u=Math.min.apply(null,r),t.rect(s,u,i-s,o-u)},e.prototype._paintOHLC=function(e){var t=e.h,n=e.l,r=e.o,i=e.c,s=this.options.canvas,o=["M",t.x,",",t.y,"V",n.y],u=["M",r.x,",",r.y,"H",t.x],a=["M",t.x,",",i.y,"H",i.x],f,l,c,h;return f=s.path(o.join("")),l=s.path(u.join("")),c=s.path(a.join("")),h=this._paintTracker(e,s),this._setTrackerForCandlestickEle([f,l,c],h),this.group.push(l,c,f),{highLow:f,open:l,close:c,path:h}},e.prototype._setTrackerForCandlestickEle=function(e,t){$.each(e,function(e,n){n.node.tracker=t})},e.prototype._paintHL=function(e){var t=e.h,n=e.l,r=this.options.canvas,i,s;return i=r.path(["M",t.x,",",t.y,"V",n.y].join("")),s=i.clone(),this._setTrackerForCandlestickEle([i],s),this.group.push(i),{highLow:i,path:s}},e.prototype._paintCandlestick=function(e){var t=e.h,n=e.l,r=e.o,i=e.c,s=this.options.canvas,o,u,a,f,l,c,h,p,d;return i.y<r.y?(f=i.y,l=r.y):(f=r.y,l=i.y),c=["M",t.x,",",t.y,"V",f],h=["M",n.x,",",n.y,"V",l],p=["M",r.x,",",f,"H",i.x,"V",l,"H",r.x,"V",f,"Z"],u=s.path(c.join("")),a=s.path(h.join("")),o=s.path(p.join("")),d=this._paintTracker(e,s),this.group.push(u,a,o),this._setTrackerForCandlestickEle([u,a,o],d),{high:u,low:a,openClose:o,path:d}},e.prototype._handleStyle=function(e,t){if(!e)return;return e.stroke||(e.stroke=e.fill),t!==!0&&$.each(["width","height"],function(t,n){e[n]&&(e["stroke-width"]=e[n],delete e[n])}),e},e.prototype._extendStyles=function(e){var t=$.extend(!0,{},e);return t&&(t.highLow=this._handleStyle(t.highLow),t.close=this._handleStyle(t.close),t.open=this._handleStyle(t.open),t.fallingClose=this._handleStyle(t.fallingClose,!0),t.risingClose=this._handleStyle(t.risingClose,!0),t.unchangeClose=this._handleStyle(t.unchangeClose,!0)),t},e.prototype._paintCandlesticks=function(){var e=this,t=[],n,r=this.options,i=r.seriesList,s=r.seriesStyles,o=r.seriesHoverStyles,u=this.element.data("fields")||{},a=u.chartElements||{},f=a.candlestickEles||[];$.each(i,function(r,i){var u=e._extendStyles(s[r]),a=e._extendStyles(o[r]);n=e._paintCandlestickElements(i,u,a),f=f.concat(n),t.push(n)}),u.seriesEles=t,u.trackers=this.trackers,a.candlestickEles=f,a.group=this.group,u.chartElements=a,this.fields=u,this.trackers.toFront()},e.prototype._playAnimation=function(){var e=this.options.animation,t=e&&e.enabled,n,r;t&&(n=e.duration||400,r=e.easing,this.group.attr("clip-rect",[this.bounds.startX,this.bounds.startY,0,this.height].join(",")),this.group.wijAnimate({"clip-rect":[this.bounds.startX,this.bounds.startY,this.width,this.height].join(",")},n,r))},e.prototype.render=function(){this.group=this.options.canvas.group(),this._paintCandlesticks(),this.element.data("fields",this.fields),this._unbindLiveEvents(),this._bindLiveEvents(),this._playAnimation()},e}();e.CandlestickChartRender=a;var f=function(){function e(){this.type=r,this.animation={enabled:!0,duration:400,easing:">"},this.wijCSS={wijCandlestickChart:"wijmo-wijcandlestickchart",candlestickChart:"wijcandlestickchart",candlestickChartTracker:"candlesticktracker"},this.candlestickFormatter=null,this.showChartLabels=!0,this.chartLabelStyle={},this.chartLabelFormatString="",this.hint={contentStyle:{"font-size":12}},this.mouseDown=null,this.mouseUp=null,this.mouseOver=null,this.mouseOut=null,this.mouseMove=null,this.click=null}return e}();u.prototype.options=$.extend(!0,{},e.wijchartcore.prototype.options,new f),u.prototype.widgetEventPrefix=t,$.wijmo.registerWidget(t,u.prototype)})(e.chart||(e.chart={}));var t=e.chart})(wijmo||(wijmo={}));